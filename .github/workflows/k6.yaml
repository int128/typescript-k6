name: k6

on:
  pull_request:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    services:
      datadog-agent:
        image: datadog/agent:7.63.2
        env:
          # https://docs.datadoghq.com/containers/docker/?tab=standard#environment-variables
          DD_API_KEY: ${{ secrets.DATADOG_API_KEY }}
          # https://docs.datadoghq.com/opentelemetry/interoperability/otlp_ingest_in_the_agent/?tab=docker
          DD_OTLP_CONFIG_RECEIVER_PROTOCOLS_GRPC_ENDPOINT: 0.0.0.0:4317
        ports:
          - 4317:4317
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
      - run: npm install -g pnpm@latest-10
      - run: pnpm i
      - run: pnpm build

      - uses: aquaproj/aqua-installer@v3.1.1
        with:
          aqua_version: v2.45.0

      - run: k6 run lib/http-get.js
        env:
          # https://grafana.com/docs/k6/latest/results-output/real-time/opentelemetry/
          K6_OUT: experimental-opentelemetry
          K6_OTEL_GRPC_EXPORTER_INSECURE: true
          K6_OTEL_METRIC_PREFIX: k6.

      # Wait for the Datadog Agent to flush the metrics.
      - run: sleep 10
